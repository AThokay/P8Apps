(function(){function u(a){function c(){k(0);delete b.gatt;delete b.ancs;NRF.getGattforCentralServer||NRF.disconnect();setTimeout(function(){NRF.wake()},500)}var d;b.gatt=a;k(1);b.gatt.device.on("gattserverdisconnected",function(f){d&&clearInterval(d);e&&clearInterval(e);c()});E.on("kill",function(){b.gatt.disconnect().then(function(){NRF.sleep()})});NRF.setSecurity({passkey:"123456",mitm:1,display:1});var e=setTimeout(function(){d&&clearInterval(d);b.gatt.disconnect().then(c)},1E4);b.gatt.startBonding().then(function(){d=
    setInterval(function(){var f=b.gatt.getSecurityStatus();f.connected?f.connected&&f.encrypted&&(clearInterval(d),clearTimeout(e),k(2),z()):(clearInterval(d),clearTimeout(e))},1E3)})["catch"](function(f){Terminal.println("ERROR "+f)})}function z(){b.ancs={primary:null,notify:null,control:null,data:null};b.gatt.getPrimaryService("7905F431-B5CE-4E99-A40F-4B1E122D00D0").then(function(a){b.ancs.primary=a;return a.getCharacteristic("9FBF120D-6301-42D9-8C58-25E699A21DBD")}).then(function(a){b.ancs.notify=
    a;return b.ancs.primary.getCharacteristic("69D1D8F3-45E1-49A8-9821-9BBDFDAAD9D9")}).then(function(a){b.ancs.control=a;return b.ancs.primary.getCharacteristic("22EAC6E9-24D6-4BB5-BE44-B36ACE7C7BFB")}).then(function(a){b.ancs.data=a;k(3);b.ancs.notify.on("characteristicvaluechanged",function(c){var d=c.target.value,e=d.getUint8(0);c=d.getUint8(2);d=d.getUint32(4,!0);1<e||(m&&clearTimeout(m),A.includes(c)&&(e=b.notqueue.length,1==c?(h&&(b.notqueue.push(b.current),h=!1),b.notqueue.push({cat:c,uid:d})):
    16>e&&(b.notqueue[e]={cat:c,uid:d}),m=setTimeout(n,1E3)))});b.ancs.data.on("characteristicvaluechanged",function(c){b.store(c.target.value.buffer);(c=b.gotmsg())&&B(b.buf,c)});b.ancs.notify.startNotifications().then(function(){b.ancs.data.startNotifications().then(function(){k(4)})})})["catch"](function(a){Terminal.println("ERROR "+a)})}function C(a){a=a.split("\n");for(var c=0;c<a.length;c++){a[c]=a[c].trim();var d=a[c];if(18<d.length){for(var e=18;10<e&&!" \t-_".includes(d[e]);)e--;10==e&&(e=18);
    a[c]=d.substr(0,e);a.splice(c+1,0,d.substr(e))}}return a.join("\n")}function D(){l=setTimeout(function(){SCREENACCESS.release();l=void 0;h=!1;n()},500)}function B(a,c){function d(F){var v=new Uint8Array(6),p=DataView(v.buffer);p.setUint8(0,2);p.setUint32(1,b.current.uid,!0);p.setUint8(5,F?0:1);b.ancs.control.writeValue(v).then(D)}b.msgTO&&clearTimeout(b.msgTO);for(var e="",f=8;f<8+c.tlen;++f)e+=String.fromCharCode(a[f]);f="";for(var q=11+c.tlen;q<11+c.tlen+c.mlen;++q)f+=String.fromCharCode(a[q]);
    f=C(f);w=e;x=f;E.showPrompt();l&&clearTimeout(l);P8.awake||P8.wake();SCREENACCESS.request();P8.buzz();1!=b.current.cat?E.showAlert(f,e).then(d.bind(null,!1)):E.showPrompt(f,{title:e,buttons:{Accept:!0,Cancel:!1}}).then(d)}function n(){if(0!=b.notqueue.length&&!h){h=!0;b.current=b.notqueue.pop();var a=DataView(b.com.buffer);6==b.current.cat?a.setUint8(8,2):a.setUint8(8,3);a.setUint32(1,b.current.uid,!0);b.inp=0;b.ancs.control.writeValue(b.com).then(function(){b.msgTO=setTimeout(function(){h=!1;b.msgTO=
    void 0;n()},1E3)})}}function k(a){r=a;WIDGETS.ancs.draw()}var y=require("Storage").readJSON("widancs.json",1)||{settings:{enabled:!1,category:[1,2,4]}},t=y.settings.enabled,A=y.settings.category,b={gatt:null,ancs:null,current:{cat:0,uid:0},notqueue:[],msgTO:void 0,com:new Uint8Array([0,0,0,0,0,1,20,0,3,100,0]),buf:new Uint8Array(132),inp:0,store:function(a){var c=this.inp;132>=c+a.length&&(this.buf.set(a,c),this.inp+=a.length)},gotmsg:function(){var a=this.inp,c=DataView(this.buf.buffer);if(8>a)return null;
    var d=c.getUint16(6,!0);if(a<d+8)return null;c=c.getUint16(9+d,!0);return a<c+d+11?null:{tlen:d,mlen:c}}};if(!NRF.getGattforCentralServer&&t&&"undefined"!=typeof SCREENACCESS)NRF.on("disconnect",function(a){NRF.sleep()});if(t&&"undefined"!=typeof SCREENACCESS)NRF.on("connect",function(a){NRF.getGattforCentralServer?u(NRF.getGattforCentralServer(a)):NRF.connect(a).then(u)});var l=void 0,h=!1;var w="";var x="NONE";var m,r=5;WIDGETS.ancs={area:"tl",width:24,draw:function(){var a=new Uint16Array([50712,
    63512,1023,65504,2016,0]),c=E.toArrayBuffer(atob("GBgBAAAABAAADgAAHwAAPwAAf4AAP4AAP4AAP4AAHwAAH4AAD8AAB+AAA/AAAfgAAf3gAH/4AD/8AB/+AA/8AAf4AAHwAAAgAAAA"));g.setColor(a[r]);g.drawImage(c,10,0)}};t&&"undefined"!=typeof SCREENACCESS&&(r=0,NRF.setServices(void 0,{uart:!1}),NRF.sleep(),NRF.wake(),NRF.setAdvertising([2,1,6,17,21,208,0,45,18,30,75,15,164,153,78,206,181,49,244,5,121],{connectable:!0,discoverable:!0,interval:375}),TC.on("swipe",function(a){SCREENACCESS.withApp&&a==TC.DOWN?(SCREENACCESS.request(),
    E.showMessage(x,w)):SCREENACCESS.withApp||a!=TC.UP||SCREENACCESS.release()}))})();